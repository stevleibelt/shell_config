#!/bin/bash
NET_BAZZLINE_FUNCTION_PACKAGEMANAGER_SYSTEM_UPGRADE_SCREEN_SESSION_NAME='system_upgrade'

#a

####
# @param: <string> packagemanager_command
# [@param: <int> is_lts_kernel]
function net_bazzline_packagemanager_arch_linux_software_upgrade ()
{
    #bo: setup
    if [[ $# -lt 1 ]];
    then
        echo ":: Invalid amount of arguments provided."
        echo "   ${FUNCNAME[0]} <packagemanager_command: sudo pacman | yay> [<is_lts_kernel>: 0|1]"

        return 1;
    fi

    local PACKAGEMANAGER_COMMAND="${1}"
    local IS_LTS_KERNEL="${2:-0}"

    local PACMAN_LOCK_FILE_PATH='/var/lib/pacman/db.lck'
    #eo: setup

    #bo: check if packagemanager is valid
    if [[ ! -x $(command -v "${PACKAGEMANAGER_COMMAND}") ]];
    then
        echo ":: Invalid argument provided."
        echo "   Command >>${PACKAGEMANAGER_COMMAND}<< does not exist."

        return 2;
    fi
    #eo: check if packagemanager is valid

    #bo: check if lock file exists
    if [[ -f ${PACMAN_LOCK_FILE_PATH} ]];
    then
        read -p ":: Lockfile exists. Remove it? (y|N) " yn

        case ${yn} in
            [Yy]* )
                echo "   Removing lock file."
                sudo rm ${PACMAN_LOCK_FILE_PATH}
                break;;
            * ) echo "   Aborting.";
                return 2;
        esac
    fi
    #bo: check if lock file exists

    #bo: check last system update timestamp
    local CURRENT_DATETIME=$(date +'%Y-%m-%d %H:%M:%S')
    local CURRENT_TIMESTAMP=$(date +'%s')
    local LAST_SYSTEM_UPDATE_FILE_PATH="${NET_BAZZLINE_CACHE_PATH}/last_system_update"
    local REINSTALL_ARCH_KEYRING=1

    if [[ -f "${LAST_SYSTEM_UPDATE_FILE_PATH}" ]];
    then
        local LAST_SYSTEM_UPDATE_TIMESTAMP=$(head -n 4 ${LAST_SYSTEM_UPDATE_FILE_PATH})

        local LAST_VALID_TIMESTAMP=`expr ${CURRENT_TIMESTAMP} - 2419200`   #2419200 = 28 days

        if [[ ${LAST_SYSTEM_UPDATE_TIMESTAMP} -lt ${LAST_VALID_TIMESTAMP} ]];
        then
            bash -c "${PACKAGEMANAGER_COMMAND} -S archlinux-keyring"
        fi
    else
        if [[ ! -d "${NET_BAZZLINE_CACHE_PATH}" ]];
        then
            mkdir -p "${NET_BAZZLINE_CACHE_PATH}"
        fi
    fi 

    echo '#last system update datetime' > ${LAST_SYSTEM_UPDATE_FILE_PATH}
    echo "${CURRENT_DATETIME}" >> ${LAST_SYSTEM_UPDATE_FILE_PATH}
    echo '#last system update timestamp' >> ${LAST_SYSTEM_UPDATE_FILE_PATH}
    echo "${CURRENT_TIMESTAMP}" >> ${LAST_SYSTEM_UPDATE_FILE_PATH}
    #eo: check last system update timestamp

    #bo: check if screen session exists
    net_bazzline_packagemanager_check_if_system_upgrade_screen_session_exists

    if  [[ $? -eq 1 ]];
    then
        if [[ ${IS_LTS_KERNEL} -eq 1 ]];
        then
            screen -dmS ${NET_BAZZLINE_FUNCTION_PACKAGEMANAGER_SYSTEM_UPGRADE_SCREEN_SESSION_NAME} bash -c "${PACKAGEMANAGER_COMMAND} -Syyu || ${PACKAGEMANAGER_COMMAND} -Syyu --ignore=linux-lts,linux-lts-headers,zfs-linux-lts,zfs-utils"
        else
            screen -dmS ${NET_BAZZLINE_FUNCTION_PACKAGEMANAGER_SYSTEM_UPGRADE_SCREEN_SESSION_NAME} bash -c "${PACKAGEMANAGER_COMMAND} -Syyu || ${PACKAGEMANAGER_COMMAND} -Syyu --ignore=linux,linux-headers,zfs-linux,zfs-utils"
        fi
    fi

    #this line is working because we make sure that there is a screen session or we create one abouve this line
    screen -r ${NET_BAZZLINE_FUNCTION_PACKAGEMANAGER_SYSTEM_UPGRADE_SCREEN_SESSION_NAME}
    #eo: check if screen session exists
}

####
# @param: <string> packagemanager_command
function net_bazzline_packagemanager_apt_software_upgrade ()
{
    #bo: setup
    if [[ $# -lt 1 ]];
    then
        echo ":: Invalid amount of arguments provided."
        echo "   ${FUNCNAME[0]} <packagemanager_command: apt-get update && apt-get upgrade"

        return 1;
    fi

    local PACKAGEMANAGER_COMMAND="${1}"
    #eo: setup

    #bo: check if screen session exists
    net_bazzline_packagemanager_check_if_system_upgrade_screen_session_exists

    if  [[ $? -eq 1 ]];
    then
        screen -dmS ${NET_BAZZLINE_FUNCTION_PACKAGEMANAGER_SYSTEM_UPGRADE_SCREEN_SESSION_NAME} bash -c "${PACKAGEMANAGER_COMMAND}"
    fi

    screen -r ${NET_BAZZLINE_FUNCTION_PACKAGEMANAGER_SYSTEM_UPGRADE_SCREEN_SESSION_NAME}
}

#c

function net_bazzline_packagemanager_check_if_system_upgrade_screen_session_exists ()
{
    #grep -q will exit with an code != 0 if there is no running screen session.
    screen -ls | grep -q ${NET_BAZZLINE_FUNCTION_PACKAGEMANAGER_SYSTEM_UPGRADE_SCREEN_SESSION_NAME}
}
